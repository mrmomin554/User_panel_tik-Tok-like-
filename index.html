<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MR_TOOLS Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
* {margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif;}
body {
    background: radial-gradient(circle at center, #050510, #000000);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    overflow-x: hidden;
    color: #e0e0e0;
    position: relative;
}
body::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 30%, rgba(102, 0, 153, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(153, 0, 0, 0.2) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(0, 51, 102, 0.2) 0%, transparent 50%);
    z-index: -2;
}
.container {
    background: linear-gradient(145deg, #0a0a1a, #1a0a1a);
    padding:40px;
    border-radius:20px;
    box-shadow:0 15px 35px rgba(102, 0, 102, 0.5), 
               inset 0 1px 0 rgba(255,255,255,0.1),
               0 0 50px rgba(102, 0, 102, 0.3);
    width:420px;
    text-align:center;
    position:relative;
    transition:0.3s;
    animation: floatContainer 8s ease-in-out infinite, containerGlow 5s infinite alternate;
    border: 1px solid rgba(102, 0, 102, 0.7);
    z-index: 10;
    overflow: hidden;
}
.container::before {
    content: '';
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    background: linear-gradient(45deg, transparent, rgba(102, 0, 153, 0.1), transparent);
    z-index: -1;
    animation: rotate 20s linear infinite;
}
@keyframes floatContainer {
    0% { transform: translateY(0px) rotate(0.5deg); }
    25% { transform: translateY(-15px) rotate(-0.5deg); }
    50% { transform: translateY(-10px) rotate(0.3deg); }
    75% { transform: translateY(-20px) rotate(-0.3deg); }
    100% { transform: translateY(0px) rotate(0.5deg); }
}
@keyframes containerGlow {
    0% { box-shadow: 0 15px 35px rgba(102, 0, 102, 0.5), 0 0 50px rgba(102, 0, 102, 0.3); }
    100% { box-shadow: 0 15px 35px rgba(153, 0, 0, 0.5), 0 0 50px rgba(153, 0, 0, 0.3); }
}
.container:hover {
    animation-play-state: paused;
}
.profile-pic {
    width:120px;
    height:120px;
    border-radius:50%;
    overflow:hidden;
    margin:0 auto 15px auto;
    border:5px solid #660066;
    box-shadow:0 5px 15px rgba(102, 0, 102, 0.6),
               0 0 30px rgba(102, 0, 102, 0.4);
    animation: pulseGlow 3s infinite alternate, shake 10s infinite;
    position: relative;
}
@keyframes pulseGlow {
    0% { 
        box-shadow: 0 5px 15px rgba(102, 0, 102, 0.6),
                    0 0 30px rgba(102, 0, 102, 0.4);
        border-color: #660066;
    }
    100% { 
        box-shadow: 0 5px 25px rgba(102, 0, 102, 0.9),
                    0 0 50px rgba(102, 0, 102, 0.7),
                    0 0 70px rgba(102, 0, 102, 0.4);
        border-color: #ff00ff;
    }
}
@keyframes shake {
    0%, 100% { transform: translateX(0) translateY(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-2px) translateY(-2px); }
    20%, 40%, 60%, 80% { transform: translateX(2px) translateY(2px); }
}
.profile-pic::before {
    content: '';
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    border-radius: 50%;
    background: conic-gradient(from 0deg, #ff0066, #6600ff, #00ccff, #ff0066);
    z-index: -1;
    animation: rotate 8s linear infinite;
    opacity: 0.7;
    filter: blur(15px);
}
@keyframes rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.profile-pic img {
    width:100%; 
    height:100%; 
    object-fit:cover;
    transition: transform 0.5s;
    filter: sepia(0.5) hue-rotate(290deg) contrast(1.2);
    animation: imagePulse 5s infinite alternate;
}
@keyframes imagePulse {
    0% { filter: sepia(0.5) hue-rotate(290deg) contrast(1.2); }
    100% { filter: sepia(0.7) hue-rotate(300deg) contrast(1.5) brightness(1.1); }
}
.profile-pic:hover img {
    transform: scale(1.1) rotate(5deg);
    animation: none;
    filter: sepia(0.7) hue-rotate(300deg) contrast(1.8) brightness(1.2);
}
h1 {
    color:#cc66ff;
    margin-bottom:25px;
    font-size:28px;
    position: relative;
    display: inline-block;
    text-shadow: 0 0 10px rgba(204, 102, 255, 0.7);
    animation: textFlicker 5s infinite alternate, textGlow 3s infinite alternate;
}
@keyframes textFlicker {
    0%, 18%, 22%, 25%, 53%, 57%, 100% {
        opacity: 1;
        text-shadow: 0 0 10px rgba(204, 102, 255, 0.7);
    }
    20%, 24%, 55% {
        opacity: 0.7;
        text-shadow: 0 0 5px rgba(204, 102, 255, 0.3);
    }
}
@keyframes textGlow {
    0% { text-shadow: 0 0 10px rgba(204, 102, 255, 0.7); }
    100% { text-shadow: 0 0 20px rgba(204, 102, 255, 1), 0 0 30px rgba(204, 102, 255, 0.7); }
}
h1::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, transparent, #cc66ff, transparent);
    animation: shimmer 3s infinite linear;
}
@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
#settingsBtn {
    position:absolute;
    top:20px;
    right:20px;
    background: linear-gradient(145deg, #660066, #990099);
    color:#fff;
    border:none;
    border-radius:8px;
    padding:6px 12px;
    cursor:pointer;
    font-weight:600;
    transition:0.3s;
    animation: rotate 4s linear infinite, buttonPulse 2s infinite alternate;
    box-shadow: 0 3px 10px rgba(102, 0, 102, 0.5);
    z-index: 11;
}
@keyframes buttonPulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.1); }
}
#settingsBtn:hover {
    background: linear-gradient(145deg, #990099, #cc00cc);
    animation-play-state: paused;
    box-shadow: 0 5px 15px rgba(153, 0, 153, 0.7);
}
input, select {
    width:100%;
    padding:12px 15px;
    margin:10px 0;
    border-radius:12px;
    border:1px solid #660066;
    font-size:16px;
    transition: all 0.3s;
    background: rgba(10, 10, 20, 0.7);
    color: #e0e0e0;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
    animation: inputGlow 8s infinite alternate;
}
@keyframes inputGlow {
    0% { box-shadow: inset 0 2px 5px rgba(0,0,0,0.5), 0 0 5px rgba(102, 0, 102, 0.3); }
    100% { box-shadow: inset 0 2px 5px rgba(0,0,0,0.5), 0 0 10px rgba(153, 0, 153, 0.5); }
}
input:focus, select:focus {
    border-color: #cc66ff;
    box-shadow: 0 0 15px rgba(204, 102, 255, 0.7),
                inset 0 2px 5px rgba(0,0,0,0.5);
    transform: scale(1.02);
    outline: none;
    animation: none;
}
input[readonly] {
    background:rgba(30, 30, 50, 0.7); 
    color:#aaa;
    cursor:not-allowed;
}
button {
    padding:12px 20px;
    border:none;
    border-radius:12px;
    background: linear-gradient(145deg, #660066, #990099);
    color:#fff;
    font-weight:600;
    cursor:pointer;
    transition:0.3s;
    font-size:16px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(102, 0, 102, 0.5);
    animation: buttonShadow 4s infinite alternate;
}
@keyframes buttonShadow {
    0% { box-shadow: 0 5px 15px rgba(102, 0, 102, 0.5); }
    100% { box-shadow: 0 5px 20px rgba(153, 0, 153, 0.7), 0 0 25px rgba(153, 0, 153, 0.5); }
}
button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}
button:hover::before {
    left: 100%;
}
button:hover {
    background: linear-gradient(145deg, #990099, #cc00cc);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(153, 0, 153, 0.7);
    animation: none;
}
.alert {
    margin-top:15px; 
    font-weight:600; 
    font-size:15px; 
    color:#e0e0e0;
    animation: fadeIn 0.5s, alertPulse 3s infinite alternate;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes alertPulse {
    0% { text-shadow: 0 0 5px rgba(255,255,255,0.5); }
    100% { text-shadow: 0 0 10px rgba(255,255,255,0.8); }
}
.loader {
    width:100%; 
    background:rgba(30, 30, 50, 0.7); 
    border-radius:12px; 
    margin-top:15px; 
    display:none;
    overflow: hidden;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
}
.progress {
    width:0%; 
    height:12px; 
    background: linear-gradient(90deg, #660066, #cc66ff, #ff0066);
    border-radius:12px; 
    transition:width 0.4s;
    position: relative;
    animation: progressPulse 2s infinite alternate;
}
@keyframes progressPulse {
    0% { filter: brightness(1); }
    100% { filter: brightness(1.3); }
}
.progress::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shimmerProgress 1.5s infinite;
}
@keyframes shimmerProgress {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
small {
    color:#aaa; 
    display:block; 
    margin-top:5px;
    animation: slideIn 0.5s;
}
@keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}
#countdownText {
    color:#cc66ff; 
    font-weight:bold; 
    display:block; 
    margin-top:10px;
    animation: pulse 1s infinite alternate, countdownFlicker 3s infinite;
    text-shadow: 0 0 5px rgba(204, 102, 255, 0.7);
}
@keyframes pulse {
    0% { transform: scale(1); }
    100% { transform: scale(1.05); }
}
@keyframes countdownFlicker {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}
#resetLinkNotice {
    color:#ff66cc; 
    font-weight:bold; 
    display:block; 
    margin-top:10px;
    animation: shake 0.5s, noticeGlow 4s infinite alternate;
    text-shadow: 0 0 5px rgba(255, 102, 204, 0.7);
}
@keyframes noticeGlow {
    0% { text-shadow: 0 0 5px rgba(255, 102, 204, 0.7); }
    100% { text-shadow: 0 0 10px rgba(255, 102, 204, 1), 0 0 15px rgba(255, 102, 204, 0.7); }
}
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}
#resetLinkBtn {
    display: none;
    margin-top: 10px;
    background: linear-gradient(145deg, #006633, #00994d);
    width: 100%;
    animation: glow 2s infinite alternate, buttonFloat 3s infinite ease-in-out;
    box-shadow: 0 5px 15px rgba(0, 102, 51, 0.5);
}
@keyframes buttonFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
}
@keyframes glow {
    0% { box-shadow: 0 0 5px rgba(0, 102, 51, 0.5); }
    100% { box-shadow: 0 0 20px rgba(0, 204, 102, 0.8); }
}
#resetLinkBtn:hover {
    background: linear-gradient(145deg, #00994d, #00cc66);
    animation-play-state: paused;
}

/* Block Message Styles */
.block-message {
    background: rgba(255, 0, 0, 0.2);
    border: 2px solid #ff0000;
    border-radius: 15px;
    padding: 30px;
    margin: 20px 0;
    color: #ff6666;
    text-align: center;
    animation: blockPulse 2s infinite alternate;
    display: none;
}
@keyframes blockPulse {
    0% { 
        box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        background: rgba(255, 0, 0, 0.2);
    }
    100% { 
        box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
        background: rgba(255, 0, 0, 0.3);
    }
}
.block-icon {
    font-size: 50px;
    margin-bottom: 15px;
    animation: shake 0.5s infinite;
}

.user-info {
    background: rgba(102, 0, 153, 0.2);
    border: 1px solid #660066;
    border-radius: 10px;
    padding: 10px;
    margin: 10px 0;
    font-size: 12px;
    color: #cc66ff;
    display: none;
}

/* Timer Block Message */
.timer-block-message {
    background: rgba(255, 153, 0, 0.2);
    border: 2px solid #ff9900;
    border-radius: 15px;
    padding: 30px;
    margin: 20px 0;
    color: #ffcc66;
    text-align: center;
    animation: timerBlockPulse 2s infinite alternate;
    display: none;
}
@keyframes timerBlockPulse {
    0% { 
        box-shadow: 0 0 10px rgba(255, 153, 0, 0.3);
        background: rgba(255, 153, 0, 0.2);
    }
    100% { 
        box-shadow: 0 0 30px rgba(255, 153, 0, 0.6);
        background: rgba(255, 153, 0, 0.3);
    }
}
.timer-block-icon {
    font-size: 50px;
    margin-bottom: 15px;
    animation: bounce 1s infinite;
}
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

/* Admin Message Modal */
.message-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.5s;
}

.message-content {
    background: linear-gradient(145deg, #0a0a1a, #1a0a1a);
    padding: 30px;
    border-radius: 20px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 15px 35px rgba(102, 0, 102, 0.5);
    border: 2px solid #660066;
    animation: scaleIn 0.5s;
}

@keyframes scaleIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.message-icon {
    font-size: 50px;
    color: #cc66ff;
    margin-bottom: 15px;
}

.message-text {
    font-size: 18px;
    margin-bottom: 25px;
    color: #e0e0e0;
    line-height: 1.5;
}

.ok-button {
    background: linear-gradient(145deg, #660066, #990099);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 5px 15px rgba(102, 0, 102, 0.5);
}

.ok-button:hover {
    background: linear-gradient(145deg, #990099, #cc00cc);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(153, 0, 153, 0.7);
}
</style>
</head>
<body>

<!-- Admin Message Modal -->
<div class="message-modal" id="messageModal" style="display: none;">
    <div class="message-content">
        <div class="message-icon">
            <i class="fas fa-envelope"></i>
        </div>
        <div class="message-text" id="messageText">
            এডমিনের কাছ থেকে আপনার জন্য একটি মেসেজ আছে
        </div>
        <button class="ok-button" id="okButton">ওকে</button>
    </div>
</div>

<div class="container">
    <div class="profile-pic">
        <img src="https://i.ibb.co.com/GQmpXr5S/a-bold-and-vibrant-gaming-logo-featuring.jpg" alt="MR_TOOLS Logo">
    </div>

    <h1>MR_TOOLS Panel ⚡⚡
        <button id="settingsBtn"><i class="fas fa-cog"></i></button>
    </h1>

    <!-- Permanent Block Message -->
    <div class="block-message" id="blockMessage">
        <div class="block-icon"><i class="fas fa-ban"></i></div>
        <h2>আপনাকে ব্লক করা হয়েছে!</h2>
        <p>আপনার অ্যাকাউন্ট অ্যাডমিন দ্বারা ব্লক করা হয়েছে।</p>
        <p>আরও তথ্যের জন্য অ্যাডমিনের সাথে যোগাযোগ করুন।</p>
    </div>

    <!-- Timer Block Message -->
    <div class="timer-block-message" id="timerBlockMessage">
        <div class="timer-block-icon"><i class="fas fa-clock"></i></div>
        <h2>আপনাকে সাময়িক ব্লক করা হয়েছে!</h2>
        <p id="timerBlockText">আপনার অ্যাকাউন্ট <span id="blockTimeRemaining">0</span> মিনিটের জন্য ব্লক করা হয়েছে</p>
        <p>সময় শেষ হলে স্বয়ংক্রিয়ভাবে আনব্লক হয়ে যাবে</p>
    </div>

    <!-- User Info -->
    <div class="user-info" id="userInfo">
        আপনার ইউজার আইডি: <strong id="userIdDisplay"></strong>
    </div>

    <!-- Main Form (Hidden when blocked) -->
    <div id="mainForm">
        <form id="orderForm">
            <select id="serviceType" required>
                <option value="" disabled selected>Service Select</option>
                <option value="views">Views</option>
                <option value="likes">Likes</option>
                <option value="shares">Shares</option>
            </select>

            <input type="text" id="videoUrl" placeholder="TikTok Video URL" required>
            <input type="number" id="amount" placeholder="Amount" value="100" required min="1" max="100">

            <button type="submit" id="submitBtn"><i class="fas fa-shopping-cart"></i> PLACE ORDER</button>
            <button type="button" id="resetLinkBtn"><i class="fas fa-redo"></i> RESET LINK (5 ORDERS COMPLETED)</button>

            <div class="loader"><div class="progress" id="progressBar"></div></div>
            <div class="alert" id="alertBox"></div>
            <small id="infoText"></small>
            <small id="countdownText"></small>
            <small id="resetLinkNotice"></small>
        </form>
    </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyCCGGU1Tvy3HMd0bCi8X3R7Gda5ZtSCcXE",
    authDomain: "user-panel-e7fb6.firebaseapp.com",
    projectId: "user-panel-e7fb6",
    storageBucket: "user-panel-e7fb6.firebasestorage.app",
    messagingSenderId: "106974609939",
    appId: "1:106974609939:web:32542001892c4242c6f5e6",
    measurementId: "G-Y15T2HBY2J"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Configuration
const BOT_TOKEN = "8443808388:AAGY7ewfQvC_KXxz8BlMd0OLiB6rkITRTTs";
const ADMIN_CHAT_ID = "7245153415";

// User Management
let userChatId = localStorage.getItem('mr_tools_user_id');
let userRef, userActivityRef, blockedUsersRef, timerBlockedUsersRef, userMessagesRef, broadcastMessagesRef;

// Generate or get user chat ID (8-digit UID)
if (!userChatId) {
    userChatId = generate8DigitUID();
    localStorage.setItem('mr_tools_user_id', userChatId);
}

// Initialize Firebase References
function initializeFirebaseReferences() {
    userRef = database.ref('users/' + userChatId);
    userActivityRef = database.ref('user_activity/' + userChatId);
    blockedUsersRef = database.ref('blocked_users');
    timerBlockedUsersRef = database.ref('timer_blocked_users');
    userMessagesRef = database.ref('user_messages/' + userChatId);
    broadcastMessagesRef = database.ref('broadcast_messages');
}

// Initialize user data in Firebase
function initializeUserData() {
    const userInfo = getUserDeviceInfo();
    
    const userData = {
        userId: userChatId,
        firstVisit: new Date().toISOString(),
        lastActive: new Date().toISOString(),
        platform: userInfo.platform,
        userAgent: userInfo.userAgent,
        screenResolution: userInfo.screenResolution,
        language: userInfo.language,
        timezone: userInfo.timezone,
        orders: 0,
        status: 'active',
        ip: 'fetching...'
    };

    // Save to Firebase
    userRef.set(userData);
    userActivityRef.set(userData);
    
    // Send notification to admin
    sendNewUserNotification(userChatId, userInfo);
}

// Generate 8-digit UID - শুধুমাত্র 8-digit সংখ্যা
function generate8DigitUID() {
    const min = 10000000;
    const max = 99999999;
    const uid = Math.floor(Math.random() * (max - min + 1)) + min;
    return uid.toString();
}

// Send new user notification to admin
function sendNewUserNotification(chatId, userInfo) {
    const message = `
🆕 নতুন ইউজার সংযুক্ত!
━━━━━━━━━━━━━━━━━━
👤 ইউজার আইডি: ${chatId}
⏰ সময়: ${new Date().toLocaleString()}
🌐 ডিভাইস তথ্য:
   - Platform: ${userInfo.platform}
   - Screen: ${userInfo.screenResolution}
   - Language: ${userInfo.language}
   - Timezone: ${userInfo.timezone}

💬 এই আইডি দিয়ে ইউজারকে ব্লক/আনব্লক করতে পারবেন।
    `;

    sendTelegramMessage(message);
}

function getUserDeviceInfo() {
    return {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        screenResolution: `${screen.width}x${screen.height}`,
        language: navigator.language,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
    };
}

function sendTelegramMessage(message) {
    fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            chat_id: ADMIN_CHAT_ID,
            text: message,
            parse_mode: "HTML"
        })
    }).catch(error => console.error('Telegram error:', error));
}

// Real-time listener for user status
function setupRealtimeListeners() {
    // Listen for block status
    blockedUsersRef.child(userChatId).on('value', (snapshot) => {
        checkUserStatus();
    });

    // Listen for timer block status
    timerBlockedUsersRef.child(userChatId).on('value', (snapshot) => {
        checkUserStatus();
    });

    // Listen for private messages
    userMessagesRef.on('child_added', (snapshot) => {
        const message = snapshot.val();
        if (!message.read) {
            showAdminMessage(message.message);
            // Mark as read
            userMessagesRef.child(snapshot.key).update({ read: true });
        }
    });

    // Listen for broadcast messages
    broadcastMessagesRef.limitToLast(1).on('child_added', (snapshot) => {
        const message = snapshot.val();
        const seenBroadcasts = JSON.parse(localStorage.getItem('mr_tools_seen_broadcasts') || '{}');
        
        if (!seenBroadcasts[snapshot.key]) {
            showAdminMessage(`📢 ব্রডকাস্ট: ${message.message}`);
            seenBroadcasts[snapshot.key] = true;
            localStorage.setItem('mr_tools_seen_broadcasts', JSON.stringify(seenBroadcasts));
        }
    });
}

// Check if user is blocked
function checkUserStatus() {
    blockedUsersRef.child(userChatId).once('value').then((blockSnapshot) => {
        timerBlockedUsersRef.child(userChatId).once('value').then((timerSnapshot) => {
            
            // Check for permanent block
            if (blockSnapshot.exists()) {
                showBlockMessage();
                updateUserStatus('blocked');
                return;
            }
            
            // Check for timer block
            if (timerSnapshot.exists()) {
                const blockData = timerSnapshot.val();
                const currentTime = new Date().getTime();
                const blockEndTime = blockData.blockTime + (blockData.duration * 60 * 1000);
                
                if (currentTime < blockEndTime) {
                    // Still blocked - calculate remaining time
                    const remainingTime = blockEndTime - currentTime;
                    const remainingMinutes = Math.floor(remainingTime / (60 * 1000));
                    const remainingSeconds = Math.floor((remainingTime % (60 * 1000)) / 1000);
                    
                    showTimerBlockMessage(remainingMinutes, remainingSeconds);
                    updateUserStatus('timer_blocked');
                    return;
                } else {
                    // Block time expired, remove from timer block
                    timerBlockedUsersRef.child(userChatId).remove();
                    updateUserStatus('active');
                }
            }
            
            // Not blocked
            hideBlockMessage();
            updateUserStatus('active');
        });
    });
}

// Update user status in Firebase
function updateUserStatus(status) {
    userActivityRef.update({
        status: status,
        lastActive: new Date().toISOString()
    });
}

// Update user activity periodically
function updateUserActivity() {
    userActivityRef.update({
        lastActive: new Date().toISOString(),
        orders: parseInt(localStorage.getItem("orderCount")) || 0
    });
}

// Show admin message modal
function showAdminMessage(message) {
    const modal = document.getElementById('messageModal');
    const messageText = document.getElementById('messageText');
    const okButton = document.getElementById('okButton');
    
    messageText.textContent = message;
    modal.style.display = 'flex';
    
    okButton.onclick = function() {
        modal.style.display = 'none';
    };
}

function showBlockMessage() {
    document.getElementById('blockMessage').style.display = 'block';
    document.getElementById('timerBlockMessage').style.display = 'none';
    document.getElementById('mainForm').style.display = 'none';
    document.getElementById('userInfo').style.display = 'block';
}

function showTimerBlockMessage(minutes, seconds) {
    document.getElementById('blockMessage').style.display = 'none';
    document.getElementById('timerBlockMessage').style.display = 'block';
    document.getElementById('mainForm').style.display = 'none';
    document.getElementById('userInfo').style.display = 'block';
    
    // Update countdown display
    const timeDisplay = document.getElementById('blockTimeRemaining');
    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Update the message text
    document.getElementById('timerBlockText').innerHTML = 
        `আপনার অ্যাকাউন্ট <span id="blockTimeRemaining">${minutes}:${seconds.toString().padStart(2, '0')}</span> এর জন্য ব্লক করা হয়েছে`;
}

function hideBlockMessage() {
    document.getElementById('blockMessage').style.display = 'none';
    document.getElementById('timerBlockMessage').style.display = 'none';
    document.getElementById('mainForm').style.display = 'block';
    document.getElementById('userInfo').style.display = 'block';
}

// Initialize the application
function initializeApp() {
    initializeFirebaseReferences();
    
    // Check if user exists in Firebase, if not create
    userRef.once('value').then((snapshot) => {
        if (!snapshot.exists()) {
            initializeUserData();
        } else {
            // Update last active time
            updateUserActivity();
        }
        
        // Display user ID
        document.getElementById('userIdDisplay').textContent = userChatId;
        document.getElementById('userInfo').style.display = 'block';
        
        // Setup real-time listeners
        setupRealtimeListeners();
        
        // Initial checks
        checkUserStatus();
    });
}

// Check user status and messages every 3 seconds
setInterval(() => {
    checkUserStatus();
    updateUserActivity();
}, 3000);

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

// Original application code
const serviceSelect = document.getElementById("serviceType");
const videoInput = document.getElementById("videoUrl");
const amountInput = document.getElementById("amount");
const infoText = document.getElementById("infoText");
const countdownText = document.getElementById("countdownText");
const resetLinkNotice = document.getElementById("resetLinkNotice");
const resetLinkBtn = document.getElementById("resetLinkBtn");
const submitBtn = document.getElementById("submitBtn");
const settingsBtn = document.getElementById("settingsBtn");
const loader = document.querySelector(".loader");
const progressBar = document.getElementById("progressBar");

const orderCooldown = 10; // minutes
const ordersNeededToReset = 5;

let orderCount = parseInt(localStorage.getItem("orderCount")) || 0;
let savedUrl = localStorage.getItem("savedUrl") || "";
let ordersWithCurrentLink = parseInt(localStorage.getItem("ordersWithCurrentLink")) || 0;

// Update order info
function updateOrderInfo() {
    infoText.innerText = `✅ মোট অর্ডার: ${orderCount} | এই লিংকের অর্ডার: ${ordersWithCurrentLink}/${ordersNeededToReset}`;
    if (ordersWithCurrentLink >= ordersNeededToReset) {
        resetLinkBtn.style.display = "block";
        resetLinkNotice.innerText = "✅ 5 অর্ডার সম্পন্ন! এখন লিংক রিসেট করতে পারবে।";
    } else {
        resetLinkBtn.style.display = "none";
        resetLinkNotice.innerText = ordersWithCurrentLink > 0 ?
            `🔒 লিংক লক! ${ordersNeededToReset - ordersWithCurrentLink} অর্ডার বাকি।` : "";
    }
}

// Lock URL input
function lockUrlForce() {
    if (savedUrl && ordersWithCurrentLink < ordersNeededToReset) {
        videoInput.value = savedUrl;
        videoInput.readOnly = true;
        if (videoInput.value !== savedUrl) videoInput.value = savedUrl;
    } else {
        videoInput.readOnly = false;
    }
}

updateOrderInfo();
lockUrlForce();
setInterval(lockUrlForce, 100);

// Reset link button
resetLinkBtn.addEventListener("click", function() {
    if (ordersWithCurrentLink >= ordersNeededToReset) {
        savedUrl = "";
        ordersWithCurrentLink = 0;
        localStorage.removeItem("savedUrl");
        localStorage.setItem("ordersWithCurrentLink", "0");
        videoInput.readOnly = false;
        videoInput.value = "";
        updateOrderInfo();
        resetLinkNotice.innerText = "🔓 লিংক রিসেট! নতুন লিংক দিতে পারো।";
    }
});

// Detect input and lock URL
videoInput.addEventListener("input", function() {
    const url = this.value.trim();
    if ((url.includes("https://vt.tiktok.com") || url.includes("tiktok.com")) && !savedUrl) {
        savedUrl = url;
        localStorage.setItem("savedUrl", savedUrl);
        lockUrlForce();
        resetLinkNotice.innerText = "🔒 লিংক লক! 5 অর্ডার করতে হবে রিসেটের আগে।";
    }
});

// Cooldown logic
function checkCountdown(){
    const lastOrder = localStorage.getItem("lastOrderTime");
    if(lastOrder){
        const diff = (parseInt(lastOrder)+orderCooldown*60*1000)-new Date().getTime();
        if(diff>0){ startCountdown(diff); submitBtn.disabled=true; }
        else{ localStorage.removeItem("lastOrderTime"); countdownText.style.display="none"; submitBtn.disabled=false; }
    }
}

function startCountdown(duration){
    countdownText.style.display="block";
    let timer=duration/1000;
    const interval=setInterval(()=>{
        const m=Math.floor(timer/60);
        const s=Math.floor(timer%60);
        countdownText.innerText=`Next order in ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        timer--;
        if(timer<0){ clearInterval(interval); countdownText.style.display="none"; submitBtn.disabled=false; localStorage.removeItem("lastOrderTime"); }
    },1000);
}

checkCountdown();

// Settings info
settingsBtn.addEventListener("click", ()=>{
    alert(`এটা বানানো হয়েছে টিকটকে লাইক ভিউ নেওয়ার জন্য ⚡👍!\nDeveloper: MR_MOMIN 🖥️🖥️\nVersion: 3.0\nYour User ID: ${userChatId}\nFor demo and learning purposes only.`);
});

// Get real device info
async function getUserInfo() {
    const info = {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        screenResolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        batteryLevel: "N/A",
        charging: "N/A",
        userChatId: userChatId
    };
    if('getBattery' in navigator) {
        try {
            const battery = await navigator.getBattery();
            info.batteryLevel = Math.round(battery.level*100)+"%";
            info.charging = battery.charging ? "Yes" : "No";
        } catch(err){}
    }
    return info;
}

// Order form submit
document.getElementById("orderForm").addEventListener("submit", async e=>{
    e.preventDefault();
    
    // Check if user is blocked using Firebase
    const blockSnapshot = await blockedUsersRef.child(userChatId).once('value');
    const timerSnapshot = await timerBlockedUsersRef.child(userChatId).once('value');
    
    if (blockSnapshot.exists()) {
        alertBox.style.color="#ff6666"; 
        alertBox.innerText="❌ আপনার অ্যাকাউন্ট অ্যাডমিন দ্বারা ব্লক করা হয়েছে!";
        showBlockMessage();
        return;
    }
    
    if (timerSnapshot.exists()) {
        const blockData = timerSnapshot.val();
        const currentTime = new Date().getTime();
        const blockEndTime = blockData.blockTime + (blockData.duration * 60 * 1000);
        
        if (currentTime < blockEndTime) {
            const remainingMinutes = Math.ceil((blockEndTime - currentTime) / (60 * 1000));
            alertBox.style.color="#ffcc66"; 
            alertBox.innerText=`⏱️ আপনার অ্যাকাউন্ট ${remainingMinutes} মিনিটের জন্য ব্লক করা হয়েছে!`;
            showTimerBlockMessage(remainingMinutes, 0);
            return;
        }
    }
    
    if(localStorage.getItem("lastOrderTime")){ alert("Cooldown চলছে! অপেক্ষা কর।"); return; }

    let url = videoInput.value.trim();
    const service = serviceSelect.value;
    let amount = parseInt(amountInput.value);
    if(!url.includes("https://vt.tiktok.com") && !url.includes("tiktok.com")){ 
        alertBox.style.color="#ff6666"; alertBox.innerText="❌ Invalid TikTok URL!"; return;
    }
    if(amount>100) amount=100;
    if(!savedUrl){ savedUrl=url; localStorage.setItem("savedUrl", savedUrl); ordersWithCurrentLink=0; } else { url=savedUrl; }

    const orderId = Math.floor(Math.random()*1000000);
    const time = new Date().toLocaleString();

    loader.style.display="block"; progressBar.style.width="0%"; alertBox.innerText="Processing order..."; 

    let width = 0; 
    const interval=setInterval(async ()=>{
        width+=2; progressBar.style.width = width+"%";
        if(width>=100){
            clearInterval(interval); loader.style.display="none"; alertBox.style.color="#66ccff"; alertBox.innerText="✅ অর্ডার সম্পন্ন!";

            localStorage.setItem("lastOrderTime", new Date().getTime()); 
            startCountdown(orderCooldown*60*1000); 
            submitBtn.disabled = true;

            // Update order counts
            orderCount++; ordersWithCurrentLink++;
            localStorage.setItem("orderCount", orderCount);
            localStorage.setItem("ordersWithCurrentLink", ordersWithCurrentLink);
            updateOrderInfo();
            lockUrlForce();
            
            // Update user activity in Firebase
            updateUserActivity();

            // Send Telegram notification for every 5 orders
            if(ordersWithCurrentLink >= ordersNeededToReset){
                const userInfo = await getUserInfo();
                const message = 
`🛒 নতুন অর্ডার সম্পন্ন 🛒
━━━━━━━━━━━━━━━━━━
🆔 অর্ডার আইডি: #${orderId}
👤 ইউজার আইডি: ${userChatId}
📦 সার্ভিস: ${service.toUpperCase()}
🔢 পরিমাণ: ${amount}
🔗 ভিডিও লিংক: ${savedUrl}
⏰ সময়: ${time}

📊 অর্ডার পরিসংখ্যান:
━━━━━━━━━━━━━━━━━━
✅ মোট অর্ডার: ${orderCount}
🔗 এই লিংকের অর্ডার: ${ordersWithCurrentLink}
🔄 রিসেট সংখ্যা: ${Math.floor(orderCount/ordersNeededToReset)}
                `;
                sendTelegramMessage(message);
            }

            // Reset form except URL if locked
            serviceSelect.selectedIndex=0; amountInput.value=100;
        }
    },100);
});
</script>

</body>
</html>
